<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>114å­¸å¹´åœ‹å°ä¸™ç­é›²ç«¯è¡Œäº‹æ›†</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h2 { color: #2c3e50; }
        .controls { background: white; padding: 15px 25px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; }
        select, button { padding: 8px 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #status { font-size: 13px; color: #666; margin-left: 10px; }
        
        table { border-collapse: collapse; background: white; width: 100%; max-width: 900px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; table-layout: fixed; }
        th { background-color: #4CAF50; color: white; padding: 15px; }
        td { border: 1px solid #edf2f7; height: 110px; vertical-align: top; padding: 8px; position: relative; }
        .weekend { background-color: #fff9f9; color: #e74c3c; }
        .today { background-color: #e8f5e9 !important; border: 2px solid #4CAF50 !important; }
        .date-num { font-weight: bold; margin-bottom: 5px; display: block; }
        .note-area { font-size: 13px; line-height: 1.4; color: #34495e; min-height: 70px; outline: none; word-wrap: break-word; cursor: text; }

        .holiday-name {
            color: #e74c3c;
            font-size: 11px;
            margin-left: 5px;
            font-weight: normal;
        }
        .holiday-text { color: #e74c3c !important; } /* è®“å‡æ—¥æ•¸å­—ä¹Ÿè®Šç´… */
        
        /* è®€å–ä¸­çš„é®ç½©æ¨£å¼ */
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 10; font-size: 14px; color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>

    <h2>â˜ï¸ ç­ç´šé›²ç«¯è¡Œæ”¿è¡Œäº‹æ›†</h2>

    <div class="controls">
        <select id="yearSelect"></select> å¹´
        <select id="monthSelect"></select> æœˆ
        <button onclick="renderCalendar()">åˆ‡æ›æœˆä»½</button>
        <span id="status">é›²ç«¯åŒæ­¥å·²å•Ÿå‹•</span>
    </div>

    <div style="position: relative; width: 100%; max-width: 900px;">
        <div id="loading" class="loading-overlay" style="display:none;">è®€å–é›²ç«¯è³‡æ–™ä¸­...</div>
        <table id="calendarTable">
            <thead>
                <tr>
                    <th class="weekend">æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th class="weekend">å…­</th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxTbmF5fS85wY05e9eIMobeTKXjZz97S3VXZICcTKaCTw5oSsh1yf_opiA1w0OdJi50/exec";
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const calendarBody = document.getElementById('calendarBody');
        const statusText = document.getElementById('status');
        const loadingOverlay = document.getElementById('loading');
        // ğŸš© æ–°å¢ï¼šåœ‹å®šå‡æ—¥è³‡æ–™åº« (æœˆ-æ—¥)
const holidays = {
    "1-1": "å…ƒæ—¦",
    "2-28": "å’Œå¹³ç´€å¿µæ—¥",
    "4-4": "å…’ç«¥ç¯€",
    "4-5": "æ¸…æ˜ç¯€",
    "5-1": "å‹å‹•ç¯€",
    "10-10": "åœ‹æ…¶æ—¥"
};

async function renderCalendar() {
    loadingOverlay.style.display = 'flex';
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value); // æ³¨æ„ï¼šé€™è£¡æ”¹ç‚º 1-12
    const firstDay = new Date(year, month - 1, 1).getDay();
    const lastDate = new Date(year, month, 0).getDate();
    const today = new Date();

    const savedData = await fetchCloudData(getStorageKey());

    calendarBody.innerHTML = '';
    let dateCounter = 1;

    for (let i = 0; i < 6; i++) {
        let row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
            let cell = document.createElement('td');
            if ((i === 0 && j < firstDay) || dateCounter > lastDate) {
                cell.innerHTML = '';
            } else {
                const dateNum = dateCounter;
                const noteContent = savedData[`day-${dateNum}`] || "";
                
                // ğŸ” æª¢æŸ¥æ˜¯å¦ç‚ºåœ‹å®šå‡æ—¥
                const holidayKey = `${month}-${dateNum}`;
                const holidayName = holidays[holidayKey] || "";
                const isHoliday = holidayName !== "";

                // å»ºç«‹å…§å®¹
                let holidayHtml = isHoliday ? `<span class="holiday-name">${holidayName}</span>` : "";
                let dateClass = isHoliday || j === 0 || j === 6 ? "holiday-text" : "";

                cell.innerHTML = `
                    <span class="date-num ${dateClass}">${dateNum}${holidayHtml}</span>
                    <div class="note-area" contenteditable="true">${noteContent}</div>
                `;
                
                const noteDiv = cell.querySelector('.note-area');
                noteDiv.onblur = function() { updateCloudData(dateNum, this.innerText); };

                if (j === 0 || j === 6 || isHoliday) cell.classList.add('weekend');
                if (dateNum === today.getDate() && (month-1) === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }
                dateCounter++;
            }
            row.appendChild(cell);
        }
        calendarBody.appendChild(row);
        if (dateCounter > lastDate) break;
    }
    loadingOverlay.style.display = 'none';
    statusText.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­";
}

        function initSelectors() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            for (let y = 2020; y <= 2035; y++) {
                let opt = document.createElement('option');
                opt.value = y; opt.innerHTML = y;
                if (y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            for (let m = 1; m <= 12; m++) {
                let opt = document.createElement('option');
                opt.value = m; opt.innerHTML = m;
                if (m === currentMonth) opt.selected = true;
                monthSelect.appendChild(opt);
            }
        }

        function getStorageKey() {
            return `cal-data-${yearSelect.value}-${monthSelect.value}`;
        }

        // å¾é›²ç«¯è®€å–è³‡æ–™
       async function fetchCloudData(key) {
    try {
        // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é˜²æ­¢å¿«å–ï¼Œä¸¦å¼·åˆ¶è·Ÿéš¨å°å‘
        const response = await fetch(`${GAS_URL}?key=${key}&_t=${Date.now()}`, {
            method: 'GET',
            mode: 'cors', // æ˜ç¢ºè¦æ±‚è·¨åŸŸæ¨¡å¼
            redirect: 'follow' 
        });
        
        if (!response.ok) throw new Error('ç¶²è·¯é€£ç·šå¤±æ•—');
        
        const text = await response.text();
        console.log("å¾é›²ç«¯æŠ“å–çš„è³‡æ–™ï¼š", text);
        
        if (!text || text === "null" || text === "{}") return {};
        return JSON.parse(text);
    } catch (e) {
        console.error("ã€è®€å–éç¨‹ç™¼ç”ŸéŒ¯èª¤ã€‘ï¼š", e);
        return {};
    }
}
        // ä¸Šå‚³è³‡æ–™åˆ°é›²ç«¯
        async function updateCloudData(date, text) {
    statusText.innerText = "â˜ï¸ å„²å­˜ä¸­...";
    const key = getStorageKey();
    const currentMonthData = await fetchCloudData(key);
    currentMonthData[`day-${date}`] = text;

    try {
        await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors", // è·¨ç¶²åŸŸå¯«å…¥å¿…è¦è¨­å®š
            body: JSON.stringify({ key: key, value: JSON.stringify(currentMonthData) })
        });
        statusText.innerText = "âœ… å·²åŒæ­¥è‡³é›²ç«¯";
    } catch (e) {
        statusText.innerText = "âŒ å„²å­˜å¤±æ•—";
        console.error("å„²å­˜å¤±æ•—åŸå› :", e);
    }
}

        async function renderCalendar() {
            loadingOverlay.style.display = 'flex';
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value) - 1;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const storageKey = getStorageKey(); // å–å¾—ç›®å‰çš„ Key
            const savedData = await fetchCloudData(storageKey); // å‹™å¿…æœ‰ await
            // ... æ¥ä¸‹ä¾†æ‰æœƒé–‹å§‹ç•«æ ¼å­ ...

            calendarBody.innerHTML = '';
            let dateCounter = 1;

            for (let i = 0; i < 6; i++) {
                let row = document.createElement('tr');
                let hasActiveCell = false;
                for (let j = 0; j < 7; j++) {
                    let cell = document.createElement('td');
                    if ((i === 0 && j < firstDay) || dateCounter > lastDate) {
                        cell.innerHTML = '';
                    } else {
                        hasActiveCell = true;
                        const dateNum = dateCounter;
                        const noteContent = savedData[`day-${dateNum}`] || "";
                        
                        cell.innerHTML = `<span class="date-num">${dateNum}</span>
                                          <div class="note-area" contenteditable="true">${noteContent}</div>`;
                        
                        const noteDiv = cell.querySelector('.note-area');
                        noteDiv.onblur = function() { updateCloudData(dateNum, this.innerText); };

                        if (j === 0 || j === 6) cell.classList.add('weekend');
                        if (dateNum === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            cell.classList.add('today');
                        }
                        dateCounter++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (dateCounter > lastDate) break;
            }
            loadingOverlay.style.display = 'none';
            statusText.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­";
        }

        initSelectors();
        renderCalendar();
    </script>
</body>
</html>
